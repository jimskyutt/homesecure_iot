<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Control Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px 0;
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-connected {
            background-color: #28a745;
        }
        .status-disconnected {
            background-color: #dc3545;
        }
        .command-history {
            max-height: 400px;
            overflow-y: auto;
        }
        .command-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h2 class="h4 mb-0">ESP32 Control Panel</h2>
                    </div>
                    <div class="card-body">
                        <!-- Status Section -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-3">
                                <span class="status-indicator" id="statusIndicator"></span>
                                <span id="statusText">Status: Disconnected</span>
                            </div>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="ipInput" 
                                       placeholder="ESP32 IP (not needed with Supabase)" disabled>
                                <button class="btn btn-primary" type="button" id="btnConnect" disabled>
                                    <span class="spinner-border spinner-border-sm d-none" id="connectSpinner"></span>
                                    <span id="connectText">Using Supabase</span>
                                </button>
                            </div>
                        </div>

                        <!-- Command Buttons -->
                        <div id="commandButtons" class="command-buttons">
                            <!-- Buttons will be added here dynamically -->
                        </div>

                        <!-- Command History -->
                        <div class="mt-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="mb-0">Command History</h5>
                                <button class="btn btn-sm btn-outline-secondary" id="btnRefresh">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                            <div class="card command-history">
                                <ul class="list-group list-group-flush" id="commandHistory">
                                    <li class="list-group-item text-muted text-center py-4">Loading history...</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
<script>
    let supabase;
    const SUPABASE_URL = 'https://cfmizvheukraeksdelpv.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmbWl6dmhldWtyYWVrc2RlbHB2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMjcyMjIsImV4cCI6MjA4MDYwMzIyMn0.JuYOGS94SfItvYYiv76iiBj9AdOH9ZJnZAa6G7tF9fs';
    
    // Initialize Supabase when the script loads
    document.addEventListener('DOMContentLoaded', () => {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        init(); // Call your init function after supabase is ready
    });

    // DOM Elements
    const elements = {
        ipInput: document.getElementById('ipInput'),
        btnConnect: document.getElementById('btnConnect'),
        statusIndicator: document.getElementById('statusIndicator'),
        statusText: document.getElementById('statusText'),
        commandHistory: document.getElementById('commandHistory'),
        connectSpinner: document.getElementById('connectSpinner'),
        connectText: document.getElementById('connectText'),
        btnRefresh: document.getElementById('btnRefresh'),
        commandButtons: document.getElementById('commandButtons')
    };

    // Command configurations - these will be populated from Supabase
    let commands = [];

    // Initialize the application
    async function init() {
        await loadCommands();
        await loadCommandHistory();
        setupRealtime();
        updateUI(true); // Connected to Supabase
    }

    // Load commands from Supabase
async function loadCommands() {
    try {
        const { data, error } = await supabase
            .from('commands')
            .select('*')
            .order('command_value', { ascending: true })
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        // Get unique commands by command_value, keeping the most recent one
        const uniqueCommands = {};
        (data || []).forEach(cmd => {
            if (cmd.command_value !== undefined && 
                (uniqueCommands[cmd.command_value] === undefined || 
                 new Date(cmd.created_at) > new Date(uniqueCommands[cmd.command_value].created_at))) {
                uniqueCommands[cmd.command_value] = cmd;
            }
        });
        
        // Convert to array
        commands = Object.values(uniqueCommands);
        
        // Update the UI
        createCommandButtons();
        return true;
    } catch (error) {
        console.error('Error loading commands:', error);
        elements.statusText.textContent = 'Error loading commands';
        return false;
    }
}

    // Create command buttons
    function createCommandButtons() {
        elements.commandButtons.innerHTML = ''; // Clear existing buttons
        
        commands.forEach(cmd => {
            if (cmd.command_value !== undefined) {
                const button = document.createElement('button');
                button.className = 'btn btn-primary me-2 mb-2';
                button.innerHTML = `<i class="bi bi-${getIconForValue(cmd.command_value)} me-1"></i> ${cmd.command || `Command ${cmd.command_value}`}`;
                button.onclick = () => sendCommand(cmd.command_value, cmd.command);
                elements.commandButtons.appendChild(button);
            }
        });
    }

    // Helper function to get icons based on command value
    function getIconForValue(value) {
        const icons = {
            0: 'power-off',
            1: 'power',
            2: 'gear',
            3: 'gear-fill',
            4: 'arrow-repeat'
        };
        return icons[value] || 'terminal';
    }

    // Send command (fetch from Supabase)
    async function sendCommand(value, commandText = '') {
    try {
        elements.statusText.textContent = 'Sending command...';
        
        // Fetch the command from Supabase
        const { data, error } = await supabase
            .from('commands')
            .select('*')
            .eq('command_value', value)
            .order('created_at', { ascending: false })
            .limit(1);
        
        if (error) throw error;
        
        if (data && data.length > 0) {
            const command = data[0];
            
            // Convert the command_value to a string and send it to the Arduino
            const commandToSend = String(command.command_value);
            
            // Here you would typically send the command to your Arduino
            // For example, using WebSockets or another communication method
            if (window.arduino && typeof window.arduino.send === 'function') {
                window.arduino.send(commandToSend);
            } else {
                console.log('Would send to Arduino:', commandToSend);
            }
            
            // Update the command with device information
            const { error: updateError } = await supabase
                .from('commands')
                .update({ 
                    device: 'web_control',
                    created_at: new Date().toISOString()
                })
                .eq('id', command.id);
            
            if (updateError) throw updateError;
            
            elements.statusText.textContent = `Command sent: ${command.command || `Value: ${value}`}`;
            return true;
        } else {
            elements.statusText.textContent = 'No matching command found';
            return false;
        }
    } catch (error) {
        console.error('Error sending command:', error);
        elements.statusText.textContent = 'Error sending command';
        return false;
    }
}

    // Load command history from Supabase
    async function loadCommandHistory() {
        try {
            elements.commandHistory.innerHTML = '<li class="list-group-item text-muted text-center py-4">Loading history...</li>';
            
            const { data, error } = await supabase
                .from('commands')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(20);
            
            if (error) throw error;
            
            if (data.length === 0) {
                elements.commandHistory.innerHTML = '<li class="list-group-item text-muted text-center py-4">No commands found</li>';
                return;
            }
            
            updateCommandHistory(data);
            
        } catch (error) {
            console.error('Error loading history:', error);
            elements.commandHistory.innerHTML = 
                '<li class="list-group-item text-danger text-center py-4">Failed to load history</li>';
        }
    }

    // Update command history UI
    function updateCommandHistory(commands) {
    elements.commandHistory.innerHTML = '';
    
    commands.forEach(cmd => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        
        const value = cmd.command_value !== undefined ? cmd.command_value : 
                    (cmd.command === '1' || cmd.command?.toLowerCase() === 'on' ? 1 : 0);
        
        li.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-1">
                <div class="d-flex align-items-center">
                    <i class="bi bi-${value ? 'check-circle' : 'circle'} me-2 
                       text-${value ? 'success' : 'secondary'}"></i>
                    <span>${cmd.command || `Command ${value}`}</span>
                </div>
                <div>
                    <small class="text-muted">${new Date(cmd.created_at).toLocaleString()}</small>
                </div>
            </div>
            ${cmd.device ? `<small class="text-muted">Device: ${cmd.device}</small>` : ''}
        `;
        
        elements.commandHistory.appendChild(li);
    });
}

    // Set up real-time updates
    function setupRealtime() {
    const subscription = supabase
        .channel('commands')
        .on('postgres_changes', 
            { 
                event: '*', 
                schema: 'public', 
                table: 'commands' 
            },
            (payload) => {
                console.log('Change received!', payload);
                loadCommands().then(() => loadCommandHistory());
            }
        )
        .subscribe();

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (subscription) {
            supabase.removeChannel(subscription);
        }
    });
}

    // Update UI state
    function updateUI(connected) {
        const statusEl = elements.statusIndicator;
        statusEl.className = 'status-indicator ' + (connected ? 'status-connected' : 'status-disconnected');
        elements.statusText.textContent = connected ? 'Connected to Supabase' : 'Disconnected';
    }

    // Event Listeners
    elements.btnRefresh?.addEventListener('click', loadCommandHistory);
</script>
</body>
</html>
